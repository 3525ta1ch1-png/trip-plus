{% extends "base.html" %}

{% block title %}{{ spot.name }}{% endblock %}
{% block header_title %}スポット詳細{% endblock %}
{% block header_action %}{% endblock %}

{% block extra_css %}
<style>
  .detail-wrap{max-width:980px;margin:0 auto;}
  .detail-layout{display:grid;grid-template-columns: 1.25fr .75fr; gap:16px; margin-top:14px;}
  @media (max-width: 900px){ .detail-layout{grid-template-columns:1fr;} }

  .card{
    background:#fff;border-radius:16px;padding:18px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid #eee;
  }

  .thumb{
    width:100%;
    height:240px;
    object-fit:cover;
    border-radius:14px;
    display:block;
    background:#f3f4f6;
    margin-bottom:12px;
  }

  h1{margin:0 0 6px;font-size:22px;}

  .info-table{width:100%;border-collapse:collapse;margin-top:10px;}
  .info-table th,.info-table td{border-bottom:1px solid #eee;padding:10px 8px;font-size:13px;vertical-align:top;}
  .info-table th{width:36%;color:#374151;text-align:left;background:#fafafa;}

  .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;}

  .muted{color:#6b7280;font-size:13px;}
</style>
{% endblock %}

{% block content %}
<div class="detail-wrap">

  <div class="detail-layout">

    <div class="card">
      {% if spot.image %}
        <img class="thumb" src="{{ spot.image.url }}" alt="{{ spot.name }}">
      {% endif %}

      <h1>{{ spot.name }}</h1>
      <div class="muted">住所：{{ spot.address|default:"-" }}</div>

      <div class="actions">
        <a class="btn" href="{% url 'spots:spot_update' spot.id %}">編集</a>
        <a class="btn btn-sub" href="{% url 'spots:spot_delete' spot.id %}">削除</a>

        <form method="post" action="{% url 'spots:favorite_toggle' spot.id %}">
          {% csrf_token %}
          {% if is_favorited %}
            <button class="btn btn-sub" type="submit">☆ お気に入り解除</button>
          {% else %}
            <button class="btn" type="submit">♡ お気に入り追加</button>
          {% endif %}
        </form>
        <a class="btn btn-secondary" href="{% url 'spots:near_search' spot.id %}">
          近くのスポット検索
        </a>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">基本情報</h2>

      {% with day_map="mon:月曜,tue:火曜,wed:水曜,thu:木曜,fri:金曜,sat:土曜,sun:日曜,holiday:年中無休,irregular:不定休"|cut:" " %}
      <table class="info-table">
        <tr><th>住所</th><td>{{ spot.address|default:"-" }}</td></tr>
        <tr><th>電話番号</th><td>{{ spot.phone|default:"-" }}</td></tr>

        <tr><th>カテゴリ</th><td>{{ spot.category|default:"-" }}</td></tr>

        <tr>
          <th>参考サイト</th>
          <td>
            {% if spot.website %}
              <a href="{{ spot.website }}" target="_blank" rel="noopener">{{ spot.website }}</a>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>

        <tr>
          <th>営業日</th>
          <td>
            {% if spot.business_days %}
              {% for d in spot.business_days %}
                {% if d == "mon" %}月曜
                {% elif d == "tue" %}火曜
                {% elif d == "wed" %}水曜
                {% elif d == "thu" %}木曜
                {% elif d == "fri" %}金曜
                {% elif d == "sat" %}土曜
                {% elif d == "sun" %}日曜
                {% elif d == "holiday" %}年中無休
                {% elif d == "irregular" %}不定休
                {% else %}{{ d }}
                {% endif %}
                {% if not forloop.last %} / {% endif %}
              {% endfor %}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>

        <tr>
          <th>営業時間</th>
          <td>
            {% if spot.open_time or spot.close_time %}
              {{ spot.open_time|default:"-" }}{% if spot.close_time %} - {{ spot.close_time }}{% endif %}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>

        <tr><th>アクセス</th><td>{{ spot.access|default:"-" }}</td></tr>

        <tr>
          <th>駐車場</th>
          <td>
            {% if spot.get_parking_display %}
              {{ spot.get_parking_display|default:"-" }}
            {% else %}
              {{ spot.parking|default:"-" }}
            {% endif %}
          </td>
        </tr>

        <tr><th>気分</th><td>{{ spot.mood|default:"-" }}</td></tr>
        <tr><th>目的</th><td>{{ spot.purpose|default:"-" }}</td></tr>
        <tr><th>時間軸</th><td>{{ spot.time_axis|default:"-" }}</td></tr>
        <tr><th>ワード</th><td>{{ spot.language|default:"-" }}</td></tr>
      </table>
      {% endwith %}

      <div class="muted" style="margin-top:10px;">
        ※不足している情報は「編集」から追加できます
      </div>
    </div>

  </div>

  <hr style="margin:20px 0;">

  <h2>クチコミ({{ reviews_count }}件)</h2>

  {% if user.is_authenticated %}
    <a class="btn" href="{% url 'spots:review_create' spot.pk %}">＋クチコミ投稿</a>
  {% else %}
    <a class="btn" href="{% url 'accounts:login' %}?next={% url 'spots:spot_detail' spot.pk %}">
      ログインしてクチコミ投稿
    </a>
    <div class="muted" style="margin-top:6px;">※投稿するにはログインが必要です</div>
  {% endif %}

  {% if reviews %}
    {% for r in reviews %}
      <div style="background:#fff; padding:12px; border-radius:12px; margin-top:10px; border:1px solid #eee;">
        <div>
          {{ r.user }} /
          {% for i in "12345" %}
            {% if forloop.counter <= r.rating %}
              <span style="color:#f59e0b;">★</span>
            {% else %}
              <span style="color:#d1d5db;">☆</span>
            {% endif %}
          {% endfor %}
        </div>

        <div style="color:#555; margin-top:6px;">{{ r.comment }}</div>

        {% if user.is_authenticated and r.user_id == user.id %}
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <a class="btn btn-sub" href="{% url 'spots:review_update' r.pk %}">編集</a>

            <form method="post" action="{% url 'spots:review_delete' r.pk %}">
              {% csrf_token %}
              <button class="btn btn-sub" type="submit" onclick="return confirm('削除しますか？');">削除</button>
            </form>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <div style="background:#fff; padding:14px; border-radius:12px; margin-top:10px; border:1px dashed #ddd;">
      <p style="margin:0 0 10px;">まだクチコミがありません。</p>
      {% if user.is_authenticated %}
        <a class="btn" href="{% url 'spots:review_create' spot.pk %}">最初のクチコミを書く</a>
      {% else %}
        <a class="btn" href="{% url 'accounts:login' %}?next={% url 'spots:spot_detail' spot.pk %}">
          ログインしてから最初のクチコミを書く
        </a>
      {% endif %}
    </div>
  {% endif %}

 {% if spot.latitude and spot.longitude and bbox %}
  <div style="margin-top:18px;">
    <h3 style="margin:0 0 10px;">地図</h3>

    <iframe
      width="100%"
      height="280"
      style="border:0; border-radius:12px;"
      loading="lazy"
      src="https://www.openstreetmap.org/export/embed.html?bbox={{ bbox.left }},{{ bbox.bottom }},{{ bbox.right }},{{ bbox.top }}&layer=mapnik&marker={{ spot.latitude }},{{ spot.longitude }}">
    </iframe>

    <div style="margin-top:8px;">
      <a class="btn btn-sub"
         target="_blank"
         rel="noopener"
         href="https://www.openstreetmap.org/?mlat={{ spot.latitude }}&mlon={{ spot.longitude }}#map=16/{{ spot.latitude }}/{{ spot.longitude }}">
        大きい地図で見る
      </a>
    </div>
  </div>
{% else %}
  <div style="margin-top:18px; color:#6b7280;">
    ※位置情報がまだ登録されていません
  </div>
{% endif %}
</div>
{% endblock %}