{% extends "base.html" %}

{% block title %}{{ spot.name }}{% endblock %}
{% block header_title %}スポット詳細{% endblock %}
{% block header_action %}
  <a class="btn btn-sub" href="{% url 'spots:spot_list' %}">一覧へ</a>
{% endblock %}

{% block extra_css %}
<style>
  .card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid #eee;}
  h1{margin:0 0 6px;font-size:22px;}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h1>{{ spot.name }}</h1>
  <div class="muted">住所：{{ spot.address }}</div>
</div>

<div style="display:flex; gap:10px; margin-top:14px;">
  <a class="btn" href="{% url 'spots:spot_update' spot.id %}">編集</a>
  <a class="btn btn-sub" href="{% url 'spots:spot_delete' spot.id %}">削除</a>

  <form method="post" action="{% url 'spots:favorite_toggle' spot.id %}">
    {% csrf_token %}
    {% if is_favorited %}
      <button class="btn btn-sub" type="submit">☆ お気に入り解除</button>
    {% else %}
      <button class="btn" type="submit">♡ お気に入り追加</button>
    {% endif %}
  </form>  
</div>

<hr style="margin:20px 0;">

<h2>クチコミ({{ reviews|length }}件) </h2>
{% if user.is_authenticated %}
  <a class="btn" href="{% url 'spots:review_create' spot.pk %}">＋クチコミ投稿</a>
{% else %}
  <a class="btn" href="{% url 'accounts:login' %}?next={% url 'spots:spot_detail' spot.pk %}">
    ログインしてクチコミ投稿
  </a>
  <div class="muted" style="margin-top:6px;">※投稿するにはログインが必要です</div> 
  {% endif %}

{% for r in reviews %}
  <div style="background:#fff; padding:12px; border-radius:12px; margin-top:10px">
    <div>
      {{ r.user }} /
      {% for i in "12345" %}
        {% if forloop.coynter <= r.rating %}
          <span style="color:#f59e0b;">★</span>
        {% else %}
          <span style="color:#d1d5db;">☆</span>
        {% endif %}
      {% endfor %}
      <span class="muted" style="margin-left:8px;">(rating={{ r.rating }})</span>
    </div>

    <div style="color:#555;">{{ r.comment }}</div>
  </div>
{% empty %}
  <p>まだクチコミがありません。</p>
{% endfor %}

    <div style="background:#fff; padding:14px; border-radius:12px; margin-top:10px; border:1px dashed #ddd;">
      <p style="margin:0 0 10px;">まだクチコミがありません。　</p>
      <a class="btn" href="{% url 'spots:review_create' spot.pk %}">最初のクチコミを書く</a>
    </div>
{% if avg_rating %}
  <div style="margin-top:8px; color:#f59e0b;">
    平均評価:{{ avg_rating|floatformat:1 }} ★
  </div>
{% else %}
  <div style="margin-top:8px; color:#9ca3af;">
    まだ評価がありません
  </div>
{% endif %}
{% endblock %}
